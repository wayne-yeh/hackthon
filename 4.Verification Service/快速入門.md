# TAR Verification Service - 快速入門

## 概述

TAR Verification Service 是一個用於驗證 Tokenized Asset Receipt (TAR) NFT 的微服務。它通過比較元數據哈希與鏈上存儲的哈希來確保數據完整性。

## 快速開始

### 1. 環境準備

確保您已安裝：

- Java 17+
- Maven 3.6+
- Docker (可選)

### 2. 設置環境

```bash
# 複製環境變量文件
cp env.sample .env

# 編輯配置文件
nano .env
```

### 3. 運行服務

#### 本地開發

```bash
# 安裝依賴
make install-deps

# 運行測試
make test

# 啟動服務
make run
```

#### Docker 部署

```bash
# 構建 Docker 鏡像
make docker-build

# 運行容器
make docker-run

# 或使用 docker-compose
make docker-compose-up
```

### 4. 驗證服務

服務啟動後，您可以通過以下方式驗證：

- **API 端點**: http://localhost:8082
- **Swagger UI**: http://localhost:8082/swagger-ui.html
- **健康檢查**: http://localhost:8082/api/verify/health

## API 使用示例

### 驗證 Token

```bash
# 驗證 Token ID 123
curl "http://localhost:8082/api/verify?tokenId=123"
```

響應示例：

```json
{
  "valid": true,
  "reasons": [],
  "owner": "0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6",
  "tokenURI": "https://api.example.com/metadata/123",
  "revoked": false,
  "tokenId": 123
}
```

### 驗證已撤銷的 Token

```bash
curl "http://localhost:8082/api/verify?tokenId=456"
```

響應示例：

```json
{
  "valid": false,
  "reasons": ["Token is revoked"],
  "owner": "0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6",
  "tokenURI": "https://api.example.com/metadata/456",
  "revoked": true,
  "tokenId": 456
}
```

## 測試

### 運行所有測試

```bash
make test
```

### 運行 API 測試

```bash
./test-api.sh
```

### 運行完整測試流程

```bash
./test-complete-flow.sh
```

## 配置

### 環境變量

| 變量名                 | 描述            | 默認值                                       |
| ---------------------- | --------------- | -------------------------------------------- |
| `BLOCKCHAIN_RPC_URL`   | 區塊鏈 RPC 端點 | `http://localhost:8545`                      |
| `CONTRACT_ADDRESS`     | TAR 合約地址    | `0x5FbDB2315678afecb367f032d93F642f64180aa3` |
| `METADATA_SERVICE_URL` | 元數據服務 URL  | `http://localhost:8081`                      |
| `SERVER_PORT`          | 服務端口        | `8082`                                       |

## 故障排除

### 常見問題

1. **服務無法啟動**

   - 檢查端口 8082 是否被占用
   - 確認 Java 17+ 已安裝
   - 檢查環境變量配置

2. **區塊鏈連接失敗**

   - 確認 RPC URL 正確
   - 檢查網絡連接
   - 驗證合約地址

3. **元數據獲取失敗**
   - 確認元數據服務運行正常
   - 檢查網絡連接
   - 驗證 URL 格式

### 日誌查看

```bash
# 查看應用日誌
make logs

# 或直接查看日誌文件
tail -f logs/verification-service.log
```

## 開發

### 代碼結構

```
src/
├── main/java/com/tar/verification/
│   ├── controller/     # REST 控制器
│   ├── service/        # 業務邏輯服務
│   ├── client/         # 外部服務客戶端
│   ├── dto/           # 數據傳輸對象
│   └── config/        # 配置類
└── test/java/com/tar/verification/
    ├── controller/    # 控制器測試
    ├── service/       # 服務測試
    ├── client/        # 客戶端測試
    └── integration/   # 整合測試
```

### 添加新功能

1. 編寫測試用例
2. 實現功能
3. 運行測試確保通過
4. 更新文檔

## 監控

### 健康檢查

- 端點: `/api/verify/health`
- 執行器: `/actuator/health`

### 指標

- 端點: `/actuator/metrics`
- 包含請求計數、響應時間等

## 部署

### Docker 部署

```bash
# 構建鏡像
docker build -t tar-verification-service .

# 運行容器
docker run -d \
  --name tar-verification-service \
  -p 8082:8082 \
  -e BLOCKCHAIN_RPC_URL=http://your-rpc-url:8545 \
  -e CONTRACT_ADDRESS=0xYourContractAddress \
  tar-verification-service
```

### Kubernetes 部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tar-verification-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tar-verification-service
  template:
    metadata:
      labels:
        app: tar-verification-service
    spec:
      containers:
        - name: verification-service
          image: tar-verification-service:latest
          ports:
            - containerPort: 8082
          env:
            - name: BLOCKCHAIN_RPC_URL
              value: "http://your-rpc-url:8545"
            - name: CONTRACT_ADDRESS
              value: "0xYourContractAddress"
```

## 支持

如有問題，請查看：

- README.md - 詳細文檔
- API 文檔 - Swagger UI
- 測試腳本 - 示例用法
- 日誌文件 - 錯誤診斷
