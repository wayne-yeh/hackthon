# TAR Backend Core API - 快速入門

## 簡介

這是 Tokenized Asset Receipt (TAR) 系統的核心後端 API 服務，負責協調整個收據生命週期：元數據上傳、NFT 鑄造和驗證。

## 系統需求

- Java 17 或更高版本
- Maven 3.6+ (或使用內建的 Maven Wrapper)
- Docker & Docker Compose (用於容器化部署)
- PostgreSQL 14+ (用於本地開發)
- 運行中的區塊鏈節點 (Hardhat, Sepolia 等)
- 運行中的 Metadata Service

## 快速啟動

### 1. 環境設置

```bash
# 複製環境變數範本
cp .env.sample .env

# 編輯環境變數
nano .env
```

配置以下關鍵參數：

```env
# 資料庫配置
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=tar_backend
POSTGRES_USER=taruser
POSTGRES_PASSWORD=your-password

# 區塊鏈配置
BLOCKCHAIN_RPC_URL=http://localhost:8545
CONTRACT_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
ISSUER_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

# Metadata Service 配置
METADATA_SERVICE_URL=http://localhost:8081

# API 密鑰
API_KEY_SECRET=change-this-in-production
```

### 2. 使用 Docker 啟動（推薦）

```bash
# 構建並啟動所有服務
make docker-up

# 查看日誌
make docker-logs

# 停止服務
make docker-down
```

服務啟動後可訪問：

- API: http://localhost:8080
- Swagger UI: http://localhost:8080/swagger-ui.html
- 健康檢查: http://localhost:8080/actuator/health

### 3. 本地運行（開發模式）

```bash
# 安裝 Maven Wrapper
make setup

# 構建應用
make build

# 運行測試
make test

# 啟動應用
make run
```

## API 使用範例

### 1. 發行收據

```bash
curl -X POST http://localhost:8080/api/v1/receipts/issue \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key-secret" \
  -d '{
    "invoiceNo": "INV-2024-001",
    "purchaseDate": "2024-01-15",
    "amount": 1000.00,
    "itemName": "MacBook Pro 16吋",
    "ownerAddress": "0x1234567890123456789012345678901234567890"
  }'
```

### 2. 驗證收據

```bash
curl -X POST http://localhost:8080/api/v1/receipts/verify \
  -H "Content-Type: application/json" \
  -d '{
    "tokenId": 1,
    "metadataHash": "0xabcdef..."
  }'
```

### 3. 查詢收據詳情

```bash
curl http://localhost:8080/api/v1/receipts/1/details
```

### 4. 撤銷收據

```bash
curl -X POST http://localhost:8080/api/v1/receipts/1/revoke \
  -H "X-API-Key: your-api-key-secret"
```

## 測試

### 運行所有測試

```bash
make test
```

### 生成測試覆蓋率報告

```bash
make coverage
# 在瀏覽器中打開 target/site/jacoco/index.html
```

### 運行範例請求

```bash
# 執行範例請求腳本
./scripts/example-requests.sh
```

## API 文檔

### Swagger UI（互動式文檔）

```
http://localhost:8080/swagger-ui.html
```

### OpenAPI 規範

```
http://localhost:8080/api-docs
```

## 主要端點

| 端點                                      | 方法 | 認證 | 描述                 |
| ----------------------------------------- | ---- | ---- | -------------------- |
| `/api/v1/receipts/issue`                  | POST | 需要 | 發行新收據           |
| `/api/v1/receipts/verify`                 | POST | 公開 | 驗證收據             |
| `/api/v1/receipts/{tokenId}/revoke`       | POST | 需要 | 撤銷收據             |
| `/api/v1/receipts/{tokenId}/details`      | GET  | 公開 | 查詢收據詳情         |
| `/api/v1/receipts/owner/{address}`        | GET  | 需要 | 查詢擁有者的所有收據 |
| `/api/v1/receipts/owner/{address}/active` | GET  | 需要 | 查詢擁有者的有效收據 |

## 項目結構

```
src/
├── main/
│   ├── java/com/tar/backend/
│   │   ├── BackendCoreApplication.java    # 主應用類
│   │   ├── config/                        # 配置類
│   │   ├── controller/                    # REST 控制器
│   │   ├── dto/                          # 數據傳輸對象
│   │   ├── entity/                       # JPA 實體
│   │   ├── repository/                   # 數據訪問層
│   │   └── service/                      # 業務邏輯層
│   └── resources/
│       └── application.yml               # 應用配置
└── test/                                 # 測試代碼
```

## 常見問題

### 1. 無法連接到 PostgreSQL

```bash
# 檢查 PostgreSQL 是否運行
docker-compose ps postgres

# 查看 PostgreSQL 日誌
docker-compose logs postgres
```

### 2. 無法連接到 Metadata Service

```bash
# 驗證 Metadata Service 是否可訪問
curl http://localhost:8081/actuator/health
```

### 3. 區塊鏈連接錯誤

```bash
# 檢查區塊鏈節點是否運行
curl -X POST http://localhost:8545 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
```

### 4. 測試失敗

```bash
# 清理並重新構建
make clean build test
```

## 開發工作流程

1. **寫測試** (TDD 方法)

   ```bash
   # 編寫失敗的測試
   nano src/test/java/com/tar/backend/...

   # 運行測試確認失敗
   make test
   ```

2. **實現功能**

   ```bash
   # 實現代碼使測試通過
   nano src/main/java/com/tar/backend/...

   # 再次運行測試
   make test
   ```

3. **檢查覆蓋率**
   ```bash
   make coverage
   ```

## 部署

### Docker 部署

```bash
# 構建 Docker 映像
make docker-build

# 使用 docker-compose 部署
make docker-up
```

### 健康檢查

```bash
# 應用健康狀態
curl http://localhost:8080/actuator/health

# 詳細健康信息（需要認證）
curl -u admin:password http://localhost:8080/actuator/health
```

## 安全注意事項

- 🔑 **私鑰**: 絕不將私鑰提交到版本控制
- 🛡️ **API 密鑰**: 定期輪換 API 密鑰
- 🔒 **資料庫**: 使用強密碼並限制訪問
- 🌐 **CORS**: 在生產環境中配置允許的來源
- 📝 **日誌**: 避免記錄敏感數據

## 性能優化

- **緩存**: 啟用 Spring Cache 用於頻繁訪問的數據
- **連接池**: 使用 HikariCP 進行數據庫連接池管理
- **非同步處理**: 使用非同步操作進行非阻塞 I/O
- **索引**: 在頻繁查詢的字段上建立數據庫索引

## 監控

可訪問 Actuator 端點：

- 健康狀態: `/actuator/health`
- 應用信息: `/actuator/info`
- 指標數據: `/actuator/metrics`

## 支援

如有問題或需要幫助：

- 查閱 README.md 獲取詳細文檔
- 查閱 API_DOCUMENTATION.md 獲取 API 詳情
- 訪問 Swagger UI: http://localhost:8080/swagger-ui.html

## 下一步

1. ✅ 配置環境變數
2. ✅ 啟動服務
3. ✅ 測試 API 端點
4. 📱 整合前端 DApp
5. 🔍 設置 Verification Service
6. 🚀 部署到生產環境

## Make 命令參考

| 命令                | 描述               |
| ------------------- | ------------------ |
| `make help`         | 顯示所有可用命令   |
| `make build`        | 構建應用           |
| `make test`         | 運行測試           |
| `make run`          | 本地運行應用       |
| `make clean`        | 清理構建產物       |
| `make docker-build` | 構建 Docker 映像   |
| `make docker-up`    | 啟動 Docker 容器   |
| `make docker-down`  | 停止 Docker 容器   |
| `make coverage`     | 生成測試覆蓋率報告 |
| `make swagger`      | 打開 Swagger UI    |
