# TAR 收據合約服務 - 技術文檔

## 📋 概述

TAR 收據合約服務是一個基於 Solidity 的智能合約微服務，實現了代幣化資產收據 (Tokenized Asset Receipt, TAR) 的完整生命週期管理。該服務遵循 ERC-721 標準，並集成了訪問控制、元數據驗證和版稅管理功能。

## 🏗️ 架構設計

### 核心組件

1. **TARReceipt.sol** - 主智能合約
2. **測試套件** - 全面的單元測試和集成測試
3. **部署腳本** - 自動化部署和配置
4. **操作腳本** - 合約交互和管理工具

### 技術棧

- **Solidity**: ^0.8.20
- **Hardhat**: ^2.19.0
- **TypeScript**: ^5.0.0
- **OpenZeppelin**: ^5.0.0
- **測試框架**: Chai, Mocha, Hardhat Network Helpers
- **覆蓋率工具**: Solidity Coverage
- **Gas 報告**: Hardhat Gas Reporter

## 🔧 智能合約詳解

### 合約繼承結構

```solidity
contract TARReceipt is ERC721, AccessControl, ERC2981, Pausable
```

- **ERC721**: NFT 標準實現
- **AccessControl**: 角色基礎訪問控制
- **ERC2981**: 版稅標準支持
- **Pausable**: 緊急暫停機制

### 核心功能實現

#### 1. 鑄造功能 (Minting)

```solidity
function mint(
    address to,
    string memory uri,
    bytes32 metaHash
) external onlyRole(ISSUER_ROLE) whenNotPaused
```

**功能特點：**

- 僅限 ISSUER_ROLE 調用
- 合約暫停時無法鑄造
- 存儲元數據哈希用於驗證
- 自動分配唯一 Token ID
- 發出 Minted 事件

**安全檢查：**

- 接收者地址不能為零地址
- TokenURI 不能為空
- 元數據哈希必須提供

#### 2. 撤銷功能 (Revocation)

```solidity
function revoke(uint256 tokenId) external onlyRole(ISSUER_ROLE) whenNotPaused
```

**功能特點：**

- 僅限 ISSUER_ROLE 調用
- 標記代幣為已撤銷狀態
- 防止重複撤銷
- 發出 Revoked 事件

**安全檢查：**

- 代幣必須存在
- 代幣不能已經被撤銷

#### 3. 驗證功能 (Verification)

```solidity
function verify(uint256 tokenId, bytes32 metaHash) external view returns (bool)
```

**驗證邏輯：**

1. 檢查代幣是否存在
2. 檢查代幣是否已撤銷
3. 比較提供的哈希與存儲的哈希

### 存儲結構

```solidity
// 狀態變量
uint256 private _tokenIdCounter;                    // 代幣計數器
mapping(uint256 => bytes32) private _metaHashes;    // 元數據哈希映射
mapping(uint256 => bool) private _revokedTokens;    // 撤銷狀態映射
mapping(uint256 => string) private _tokenURIs;      // TokenURI 映射
```

### 事件定義

```solidity
event Minted(uint256 indexed tokenId, address indexed to, bytes32 indexed metaHash);
event Revoked(uint256 indexed tokenId);
```

## 🧪 測試策略

### 測試覆蓋率

- **總覆蓋率**: 97.3%
- **函數覆蓋率**: 100%
- **行覆蓋率**: 97.3%
- **分支覆蓋率**: 88.46%

### 測試類別

#### 1. 部署測試

- 合約名稱和符號設置
- 默認管理員角色分配
- 初始代幣計數器

#### 2. 角色管理測試

- 管理員權限授予和撤銷
- 非管理員權限限制
- 角色驗證

#### 3. 鑄造測試

- 成功鑄造場景
- 元數據哈希存儲
- 事件發出
- 錯誤情況處理

#### 4. 驗證測試

- 有效代幣驗證
- 無效哈希處理
- 不存在的代幣
- 已撤銷代幣

#### 5. 撤銷測試

- 成功撤銷
- 重複撤銷防護
- 權限檢查
- 暫停狀態處理

#### 6. 邊界情況測試

- 零地址處理
- 空字符串處理
- 多個鑄造處理
- 轉移限制

## 🚀 部署流程

### 1. 環境準備

```bash
# 安裝依賴
npm install

# 編譯合約
npx hardhat compile
```

### 2. 本地部署

```bash
# 啟動本地節點
npx hardhat node

# 部署合約
npm run deploy:local
```

### 3. 測試網部署

```bash
# 配置環境變量
cp env.sample .env
# 編輯 .env 文件

# 部署到 Sepolia
npm run deploy:sepolia
```

### 4. 合約配置

```bash
# 設置發行者角色
npm run set-issuer

# 驗證部署
npm run verify
```

## 🔧 操作腳本詳解

### deploy.ts - 部署腳本

**功能：**

- 部署 TARReceipt 合約
- 保存部署信息到 addresses.json
- 導出合約 ABI
- 生成部署報告

**輸出文件：**

- `deploy/addresses.json` - 部署信息
- `deploy/TARReceipt.json` - 合約 ABI

### setIssuer.ts - 角色管理

**功能：**

- 授予 ISSUER_ROLE 權限
- 驗證角色分配
- 提供操作反饋

### mint.ts - 鑄造腳本

**功能：**

- 鑄造新的 TAR 收據
- 生成示例元數據
- 計算元數據哈希
- 驗證鑄造結果

### verify.ts - 驗證腳本

**功能：**

- 驗證 TAR 收據真實性
- 比較元數據哈希
- 檢查撤銷狀態
- 提供詳細驗證報告

### revoke.ts - 撤銷腳本

**功能：**

- 撤銷指定的 TAR 收據
- 驗證撤銷權限
- 確認撤銷狀態

## 🔒 安全考量

### 1. 訪問控制

- **角色分離**: 管理員和發行者角色分離
- **權限最小化**: 每個角色僅有必要的權限
- **權限驗證**: 所有敏感操作都進行權限檢查

### 2. 輸入驗證

- **地址驗證**: 防止零地址攻擊
- **字符串驗證**: 防止空字符串攻擊
- **數值驗證**: 防止溢出和下溢

### 3. 狀態管理

- **暫停機制**: 緊急情況下可暫停合約
- **撤銷追蹤**: 完整的撤銷狀態管理
- **不可變性**: 關鍵數據一旦設置不可更改

### 4. Gas 優化

- **存儲優化**: 高效的存儲模式
- **函數優化**: 最小化外部調用
- **事件優化**: 精簡的事件結構

## 📊 性能指標

### Gas 消耗

| 操作 | Gas 消耗 | 說明                  |
| ---- | -------- | --------------------- |
| 鑄造 | ~150,000 | 包含元數據存儲和事件  |
| 撤銷 | ~45,000  | 狀態更新和事件        |
| 驗證 | ~2,500   | 視圖函數，無 Gas 消耗 |
| 轉移 | ~65,000  | 標準 ERC-721 轉移     |

### 測試性能

- **編譯時間**: < 30 秒
- **測試執行**: < 2 分鐘
- **部署時間**: < 1 分鐘
- **覆蓋率生成**: < 3 分鐘

## 🔄 集成指南

### 與其他微服務集成

#### 1. Backend Core API 集成

```typescript
// 合約地址和 ABI
const contractAddress = "0x...";
const contractABI = require("./deploy/TARReceipt.json");

// 初始化合約實例
const tarReceipt = new ethers.Contract(contractAddress, contractABI, provider);
```

#### 2. Metadata Service 集成

```typescript
// 元數據哈希計算
const metadataHash = ethers.keccak256(ethers.toUtf8Bytes(metadataJSON));

// 驗證元數據完整性
const isValid = await tarReceipt.verify(tokenId, metadataHash);
```

#### 3. Verification Service 集成

```typescript
// 驗證 TAR 收據
async function verifyTARReceipt(tokenId: number, metadataHash: string) {
  const isRevoked = await tarReceipt.isRevoked(tokenId);
  const isValid = await tarReceipt.verify(tokenId, metadataHash);

  return {
    valid: isValid && !isRevoked,
    revoked: isRevoked,
    exists: (await tarReceipt.ownerOf(tokenId)) !== ethers.ZeroAddress,
  };
}
```

## 🛠️ 開發工作流

### 1. 本地開發

```bash
# 啟動開發環境
make dev-setup

# 運行測試
make test

# 部署到本地
make deploy-local
```

### 2. 測試流程

```bash
# 運行所有測試
make test

# 運行 Gas 測試
make test-gas

# 生成覆蓋率報告
make coverage
```

### 3. 部署流程

```bash
# 本地部署
make deploy-local

# 測試網部署
make deploy-sepolia

# 完整部署流程
make deploy-full
```

## 📈 監控和維護

### 1. 合約監控

- **事件監聽**: 監聽 Minted 和 Revoked 事件
- **狀態檢查**: 定期檢查合約狀態
- **Gas 監控**: 監控 Gas 消耗變化

### 2. 安全審計

- **代碼審查**: 定期代碼審查
- **安全測試**: 滲透測試和漏洞掃描
- **依賴更新**: 保持依賴項最新

### 3. 性能優化

- **Gas 優化**: 持續優化 Gas 消耗
- **存儲優化**: 優化存儲結構
- **函數優化**: 改進函數實現

## 🎯 最佳實踐

### 1. 開發實踐

- **TDD 方法**: 測試驅動開發
- **代碼覆蓋率**: 保持高覆蓋率
- **文檔更新**: 及時更新文檔

### 2. 部署實踐

- **環境隔離**: 開發、測試、生產環境分離
- **版本控制**: 使用版本標籤
- **回滾準備**: 準備回滾方案

### 3. 安全實踐

- **私鑰管理**: 安全的私鑰存儲
- **權限管理**: 最小權限原則
- **監控告警**: 設置安全監控

## 📚 參考資源

### 技術文檔

- [OpenZeppelin 文檔](https://docs.openzeppelin.com/)
- [Hardhat 文檔](https://hardhat.org/docs)
- [ERC-721 標準](https://eips.ethereum.org/EIPS/eip-721)
- [ERC-2981 標準](https://eips.ethereum.org/EIPS/eip-2981)

### 安全資源

- [Solidity 安全最佳實踐](https://consensys.github.io/smart-contract-best-practices/)
- [OpenZeppelin 安全指南](https://docs.openzeppelin.com/contracts/security)
- [智能合約安全檢查清單](https://github.com/ConsenSys/smart-contract-best-practices)

---

**本文檔持續更新，如有問題請聯繫開發團隊。**

